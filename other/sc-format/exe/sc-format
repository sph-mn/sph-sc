#!/usr/bin/guile
!#

(use-modules (sph) (sph cli)
  (sph hashtable) (sph lang sc-format)
  (ice-9 match) (sph lang scheme) (sph alist) (sph tree) (sph list) (srfi srfi-1))

(define cli
  (cli-create #:options
    (q
      ( (format #:value-required? #t
          #:description
          "custom configuration for expression distribution. example: \"1,1,1:myprefix1,myprefix2;2,1,1:myprefix3\"")))))

(define (parse-format a)
  (map
    (l (a)
      (apply (l (counts prefixes) (list (map string->number counts) (map string->symbol prefixes)))
        (map (l (a) (string-split a #\,)) (string-split a #\:))))
    (string-split a #\;)))

(define (merge-simplify a)
  (if (and (not (null? a)) (contains? (quote (define begin)) (first a)))
    (fold
      (l (p a)
        (map-consecutive (l (b) (and (list? b) (not (null? b)) (p b)))
          (l b (append (first b) (apply append (map (l (b) (tail b)) (tail b))))) a))
      a
      (pair (l (a) (match a (((quote define) (? symbol?) value _ ...) #t) (_ #f)))
        (map (l (prefix) (l (a) (eq? prefix (first a)))) (quote (declare set set+ set- pre-define)))))
    a))

(define (replace-simplify a)
  (match a (((quote pointer-get) (? symbol? b)) (symbol-append (q *) b))
    (((quote address-of) (? symbol? b)) (symbol-append (q &) b))
    ( ( (quote struct-get) (? symbol? b) ...)
      (string->symbol (string-join (map symbol->string b) ".")))
    ( ( (quote struct-pointer-get) (? symbol? b) ...)
      (string->symbol (string-join (map symbol->string b) ":")))
    (_ a)))

(define (merge-and-simplify a)
  "currently not used because it merges subsequent set in if, for, and custom macros"
  (tree-map-lists-self (l (a) (replace-simplify (merge-simplify a))) a))

(define (sc-format-cli)
  (let* ((options (cli)) (format (alist-ref options (q format))))
    (if format
      (each
        (l (a)
          (apply
            (l (counts prefixes)
              (each (l (prefix) (ht-set! sc-formatters prefix (apply sc-f counts))) prefixes))
            a))
        (parse-format format)))
    (display (sc-format (merge-and-simplify (port->datums (current-input-port) read))))))

(sc-format-cli)
